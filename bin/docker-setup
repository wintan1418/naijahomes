#!/usr/bin/env bash
set -e

echo "ğŸš€ Setting up NaijaRent with Docker..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Docker is not running. Please start Docker and try again."
  exit 1
fi

# Copy .env.example to .env if it doesn't exist
if [ ! -f .env ]; then
  cp .env.example .env
  echo "âœ… Created .env file from .env.example"
fi

# Build the Docker images
echo "ğŸ”¨ Building Docker images..."
docker-compose build

# Start the database and redis services
echo "ğŸ—„ï¸  Starting database and Redis..."
docker-compose up -d db redis

# Wait for database to be ready
echo "â³ Waiting for database to be ready..."
docker-compose run --rm web bash -c "until pg_isready -h db -U naija_rentals; do sleep 2; done"

# Create and setup the database
echo "ğŸ“Š Setting up database..."
docker-compose run --rm web rails db:create
docker-compose run --rm web rails db:migrate

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
docker-compose run --rm web bundle install
docker-compose run --rm web yarn install

# Start all services
echo "ğŸš€ Starting all services..."
docker-compose up -d

# Start asset compilation services
echo "ğŸ¨ Starting asset compilation..."
docker-compose --profile assets up -d

echo "âœ… Setup complete!"
echo ""
echo "ğŸŒ NaijaRent is now running at: http://localhost:3000"
echo ""
echo "ğŸ“ Useful commands:"
echo "  docker-compose up          # Start all services"
echo "  docker-compose down        # Stop all services"
echo "  docker-compose logs -f web # View Rails logs"
echo "  docker-compose exec web bash # Access Rails console"
echo "  docker-compose exec web rails console # Rails console"
echo "  docker-compose exec web rails db:migrate # Run migrations"