#!/usr/bin/env bash
set -e

echo "ğŸš€ Setting up NaijaRent with Docker..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Docker is not running. Please start Docker and try again."
  exit 1
fi

# Copy .env.example to .env if it doesn't exist
if [ ! -f .env ]; then
  cp .env.example .env
  echo "âœ… Created .env file from .env.example"
fi

# Clean up any existing containers
echo "ğŸ§¹ Cleaning up existing containers..."
docker-compose down -v 2>/dev/null || true

# Build the Docker images
echo "ğŸ”¨ Building Docker images..."
docker-compose build --no-cache web

# Start the database and redis services
echo "ğŸ—„ï¸  Starting database and Redis..."
docker-compose up -d db redis

# Wait for services to be healthy
echo "â³ Waiting for services to be ready..."
sleep 10

# Create and setup the database
echo "ğŸ“Š Setting up database..."
docker-compose run --rm web bundle exec rails db:create
docker-compose run --rm web bundle exec rails db:migrate
docker-compose run --rm web bundle exec rails db:seed

# Start all services
echo "ğŸš€ Starting all services..."
docker-compose up -d

# Start asset compilation services
echo "ğŸ¨ Starting asset compilation..."
docker-compose --profile assets up -d

# Wait for Rails to start
echo "â³ Waiting for Rails to start..."
sleep 5

# Check if services are running
if docker-compose ps | grep -q "web.*Up"; then
  echo "âœ… Setup complete!"
  echo ""
  echo "ğŸŒ NaijaRent is now running at: http://localhost:3000"
  echo ""
  echo "ğŸ“ Useful commands:"
  echo "  docker-compose up          # Start all services"
  echo "  docker-compose down        # Stop all services"
  echo "  docker-compose logs -f web # View Rails logs"
  echo "  docker-compose exec web bash # Access Rails console"
  echo "  docker-compose exec web rails console # Rails console"
  echo "  docker-compose exec web rails db:migrate # Run migrations"
else
  echo "âŒ Something went wrong. Check logs with: docker-compose logs"
  exit 1
fi